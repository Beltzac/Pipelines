@page "/oracle-diff"
@inject ISignalRClientService SignalRClientService
@using Common
@using Common.ExternalApis
@using Common.Services
@using Markdig
@using Microsoft.AspNetCore.Components.Forms
@using System.Text.RegularExpressions
@using System.Reactive.Subjects
@using System.Reactive.Linq
@inject IOracleSchemaService OracleSchemaService
@inject IToastService toastService
@rendermode InteractiveServer
@inject IJSRuntime JS

<AnchorNavigation></AnchorNavigation>

<script>
 

    window.initializeDiff2Html = function (diffString) {

        //var hljs = require('highlight.js');

        console.log(diffString);
        var targetElement = document.getElementById('myDiffElement');
        var configuration = {
            drawFileList: true,
            fileListToggle: false,
            fileListStartVisible: false,
            fileContentToggle: false,
            matching: 'lines',
            outputFormat: 'side-by-side',
            synchronisedScroll: true,
            
            renderNothingWhenEmpty: true,
            rawTemplates: {
                "file-summary-line": `<li class="d2h-file-list-line">
        <span class="d2h-file-name-wrapper">
          {{>fileIcon}}
              <a href="oracle-diff#{{fileHtmlId}}" class="d2h-file-name">{{fileName}}</a>
          <span class="d2h-file-stats">
              <span class="d2h-lines-added">{{addedLines}}</span>
              <span class="d2h-lines-deleted">{{deletedLines}}</span>
          </span>
        </span>
    </li>`
    }
        };
        console.log(hljs);
        var diff2htmlUi = new Diff2HtmlUI(targetElement, diffString, configuration, hljs);
        diff2htmlUi.draw();

        hljs.configure({ ignoreUnescapedHTML: true })

        document.querySelectorAll('.hljs').forEach((block) => {
            block.classList.remove('plaintext'); // Remove the plaintext class
            block.classList.add('sql'); // Add the SQL language class
            hljs.highlightElement(block); // Highlight the block
        });

        //diff2htmlUi.highlightCode();
    };
</script>

@* target="_top" *@

<h3>Build Information</h3>

<div id="myDiffElement" style="max-width:80VW;"></div>



@code {
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var dict = OracleSchemaService.Compare();

            //var diff = OracleDiffService.GetDiffString();
            // Call JavaScript function to initialize diff2htmlUi after the page is rendered

            var diff = String.Join("\r\n", dict.Values);

            await JS.InvokeVoidAsync("initializeDiff2Html", diff);
        }
    }
}
