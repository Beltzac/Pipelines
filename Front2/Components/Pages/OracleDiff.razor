@page "/oracle-diff"
@inject ISignalRClientService SignalRClientService
@using Common
@using Common.ExternalApis
@using Common.Models
@using Common.Services
@using Markdig
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.JSInterop
@using System.Text.RegularExpressions
@using System.Reactive.Subjects
@using System.Reactive.Linq
@inject IOracleSchemaService OracleSchemaService
@inject IToastService toastService
@rendermode InteractiveServer
@inject IJSRuntime JS
@inject IConfigurationService ConfigService

<AnchorNavigation></AnchorNavigation>

<div class="row mb-4">
    <div class="col-md-5">
        <div class="form-group">
            <label>Source Environment:</label>
            <select class="form-control" @bind="selectedSourceEnv">
                @foreach (var env in environments)
                {
                    <option value="@env.Name">@env.Name</option>
                }
            </select>
        </div>
    </div>
    <div class="col-md-5">
        <div class="form-group">
            <label>Target Environment:</label>
            <select class="form-control" @bind="selectedTargetEnv">
                @foreach (var env in environments)
                {
                    <option value="@env.Name">@env.Name</option>
                }
            </select>
        </div>
    </div>
    <div class="col-md-2">
        <button class="btn btn-primary mt-4" @onclick="CompareEnvironments">Compare</button>
    </div>
</div>

<script>
    // Initialize Blazor interop
    window.blazorInstance = null;
    
    window.initializeDiff2Html = function (diffString) {

        //var hljs = require('highlight.js');

        console.log(diffString);
        var targetElement = document.getElementById('myDiffElement');
        var configuration = {
            drawFileList: true,
            fileListToggle: false,
            fileListStartVisible: false,
            fileContentToggle: false,
            matching: 'lines',
            outputFormat: 'side-by-side',
            synchronisedScroll: true,
            
            renderNothingWhenEmpty: true,
            rawTemplates: {
                "file-summary-line": `<li class="d2h-file-list-line">
                    <span class="d2h-file-name-wrapper">
                        {{>fileIcon}}
                        <a href="oracle-diff#{{fileHtmlId}}" class="d2h-file-name">{{fileName}}</a>
                        <span class="d2h-file-stats">
                            <span class="d2h-lines-added">{{addedLines}}</span>
                            <span class="d2h-lines-deleted">{{deletedLines}}</span>
                        </span>
                    </span>
                </li>`,
                "generic-line": `<tr>
                    <td class="{{lineClass}} {{type}}">
                        <div class="line-num1">{{oldNumber}}</div>
                        <div class="line-num2">{{newNumber}}</div>
                    </td>
                    <td class="{{type}}">
                        <div class="{{contentClass}}">
                            {{{content}}}
                        </div>
                    </td>
                </tr>`,
                "line-by-line-file-diff": `<div id="{{fileHtmlId}}" class="d2h-file-wrapper" data-lang="{{file.language}}">
                    <div class="d2h-file-header">
                        <span class="d2h-file-name-wrapper">
                            {{>fileIcon}}
                            <span class="d2h-file-name">{{file.fileName}}</span>
                        </span>
                        <span class="d2h-file-stats">
                            <span class="d2h-lines-added">{{file.addedLines}}</span>
                            <span class="d2h-lines-deleted">{{file.deletedLines}}</span>
                        </span>
                    </div>
                    <div class="d2h-file-diff">
                        <div class="d2h-code-wrapper">
                            <table class="d2h-diff-table">
                                <tbody class="d2h-diff-tbody">
                                    {{{diffs}}}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="d2h-file-actions mt-2 mb-4">
                        <button class="btn btn-sm btn-primary me-2" onclick="window.blazorInstance.invokeMethodAsync('ExportViewDDL', '{{file.fileName}}'.replace('.SQL', ''), window.sourceEnv)">
                            <i class="bi bi-download"></i> Source
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="window.blazorInstance.invokeMethodAsync('ExportViewDDL', '{{file.fileName}}'.replace('.SQL', ''), window.targetEnv)">
                            <i class="bi bi-download"></i> Target
                        </button>
                    </div>
                </div>`
            }
        };
        console.log(hljs);
        var diff2htmlUi = new Diff2HtmlUI(targetElement, diffString, configuration, hljs);
        diff2htmlUi.draw();

        hljs.configure({ ignoreUnescapedHTML: true })

        document.querySelectorAll('.hljs').forEach((block) => {
            block.classList.remove('plaintext'); // Remove the plaintext class
            block.classList.add('sql'); // Add the SQL language class
            hljs.highlightElement(block); // Highlight the block
        });

        //diff2htmlUi.highlightCode();
    };
</script>

@* target="_top" *@

<h3>Build Information</h3>

<div class="mb-3">
    <div class="row">
        <div class="col">
            <div id="myDiffElement" style="max-width:80VW;"></div>
        </div>
    </div>
</div>




@code {
    private List<OracleEnvironment> environments = new();
    private string selectedSourceEnv;
    private string selectedTargetEnv;
    private Dictionary<string, string> differences;

    protected override void OnInitialized()
    {
        var config = ConfigService.GetConfig();
        environments = config.OracleEnvironments;
        
        if (environments.Any())
        {
            selectedSourceEnv = environments[0].Name;
            selectedTargetEnv = environments.Count > 1 ? environments[1].Name : environments[0].Name;
        }
    }

    [JSInvokable]
    public async Task ExportViewDDL(string viewName, string envName)
    {
        // Remove the .SQL extension that diff2html adds
        viewName = viewName.Replace(".SQL", "");
        try
        {
            var config = ConfigService.GetConfig();
            var env = config.OracleEnvironments.FirstOrDefault(e => e.Name == envName);
            
            if (env == null)
            {
                toastService.ShowError($"Environment {envName} not found");
                return;
            }

            var ddl = await OracleSchemaService.GetViewDefinitionAsync(env.ConnectionString, env.Schema, viewName);
            if (!string.IsNullOrEmpty(ddl))
            {
                var fileName = $"{viewName}_{envName}_{DateTime.Now:yyyyMMdd}.sql";
                var bytes = System.Text.Encoding.UTF8.GetBytes(ddl);
                await JS.InvokeVoidAsync("downloadFile", fileName, "text/plain", Convert.ToBase64String(bytes));
                toastService.ShowSuccess($"Downloaded {fileName}");
            }
            else
            {
                toastService.ShowError($"View {viewName} not found in {envName}");
            }
        }
        catch (Exception ex)
        {
            toastService.ShowError($"Error exporting DDL: {ex.Message}");
        }
    }

    private async Task CompareEnvironments()
    {
        if (string.IsNullOrEmpty(selectedSourceEnv) || string.IsNullOrEmpty(selectedTargetEnv))
        {
            toastService.ShowError("Please select both environments");
            return;
        }

        try 
        {
            differences = OracleSchemaService.Compare(selectedSourceEnv, selectedTargetEnv);
            var diff = String.Join("\r\n", differences.Values);
            // Create JS reference and store environment variables
            await JS.InvokeVoidAsync("window.blazorInstance", DotNet.createJSObjectReference(this));
            await JS.InvokeVoidAsync("window.sourceEnv", selectedSourceEnv);
            await JS.InvokeVoidAsync("window.targetEnv", selectedTargetEnv);
            await JS.InvokeVoidAsync("initializeDiff2Html", diff);
        }
        catch (Exception ex)
        {
            toastService.ShowError($"Error comparing environments: {ex.Message}");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && environments.Count >= 2)
        {
            await CompareEnvironments();
        }
    }
}
