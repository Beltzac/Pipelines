@using Common.Services
@using static Common.Services.AutoUpdateService
@inject IAutoUpdateService AutoUpdateService

@if (updateAvailable)
{
    <a class="nav-link" href="#" @onclick="DownloadUpdateAsync">
        <span class="bi bi-cloud-arrow-down" aria-hidden="true"></span> Update Available
    <div class="progress mt-2" style="height: 20px;" hidden="@(!updateAvailable || downloadProgress == 0)">
        <div class="progress-bar" role="progressbar" style="width: @downloadProgress%;" aria-valuenow="@downloadProgress" aria-valuemin="0" aria-valuemax="100">@downloadProgress%</div>
    </div>
    </a>
}
else
{
    <a class="nav-link disabled" href="#">
        <span class="bi bi-cloud-check" aria-hidden="true"></span> Up to Date
    </a>
}

@code {
    private bool updateAvailable = false;
    private int downloadProgress = 0;
    private Release latestRelease;

    protected override async Task OnInitializedAsync()
    {
        await CheckForUpdatesAsync();
    }

    private async Task CheckForUpdatesAsync()
    {
        latestRelease = await AutoUpdateService.CheckForUpdatesAsync();
        updateAvailable = latestRelease != null;
    }

    private async Task DownloadUpdateAsync()
    {
        try
        {
            downloadProgress = 0;
            if (latestRelease != null)
            {
                await AutoUpdateService.DownloadAndInstallAsync(latestRelease, UpdateProgress);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error during update: {ex.Message}");
        }
    }

    private void UpdateProgress(int progress)
    {
        downloadProgress = progress;
        InvokeAsync(StateHasChanged);
    }
}
