@page "/slot-calculator"
@using System.Globalization
@using BlazorDateRangePicker
@using Common.Models
@using Common.Services
@using Common.Services.Interfaces
@using Common.Utils
@using TugboatCaptainsPlayground.Services
@using Microsoft.Extensions.Logging
@using TugboatCaptainsPlayground.Components.Shared
@inject SlotCalculatorStateService StateService
@inject IConfigurationService ConfigService
@inject IJSRuntime JSRuntime
@inject ILogger<SlotCalculatorPage> _logger
@inject ToastService toastService
@implements IDisposable
@inject OracleOpsService OracleOpsService

<StickyFilter>
    <div class="d-flex flex-wrap gap-3">
        <!-- Seção de Filtros e Parâmetros de Entrada -->
        <div class="col-md-4">
            <label class="form-label">Período</label>
            <DateRangePicker
                TimePicker="true" TimePicker24Hour="true"
                TimePickerSeconds="true" AutoApply="true" DateFormat="@($"dd/MM/yyyy HH:mm:ss")"
                StartDate="StateService.StartDate" EndDate="StateService.EndDate" OnRangeSelect="OnRangeSelect"
                class="form-control" />
        </div>
        <div class="col-md-3">
            <label class="form-label">Ambiente Oracle:</label>
            <EnvironmentSelector
                Environments="oracleEnvironments"
                @bind-SelectedEnvironmentName="StateService.SelectedOracleEnvironment" />
        </div>
        
        <!-- Parâmetros do Algoritmo com Dicas (Hints) para Gestão -->
        <div class="col-md-2">
            <label class="form-label" title="Quantidade de TEUs presentes no pátio no início da simulação.">
                Estoque Inicial (TEU) <i class="bi bi-info-circle-fill text-muted" style="font-size: 0.8em;"></i>
            </label>
            <input type="number" class="form-control" @bind="StateService.InitialYardTeu" />
        </div>
        <div class="col-md-2">
            <label class="form-label" title="Estimativa de quantos TEUs cada caminhão movimenta em média (fator de conversão Truck -> TEU).">
                Média TEU/Caminhão <i class="bi bi-info-circle-fill text-muted" style="font-size: 0.8em;"></i>
            </label>
            <input type="number" class="form-control" @bind="StateService.AvgTeuPerTruck" step="0.1" />
        </div>
        <div class="col-md-2">
            <label class="form-label" title="Fator de Reserva: Porcentagem da capacidade operacional (Gate/Equipamentos) que deve ser mantida livre para imprevistos.">
                Fator Reserva (%) <i class="bi bi-info-circle-fill text-muted" style="font-size: 0.8em;"></i>
            </label>
            <div class="input-group">
                <input type="number" class="form-control" @bind="ReservePercent" step="1" min="0" max="100" />
                <span class="input-group-text">%</span>
            </div>
        </div>
        <div class="col-md-2">
            <label class="form-label" title="Controla a suavidade da curva de slots. Valores mais altos evitam mudanças bruscas na abertura de agendamentos.">
                Suavização <i class="bi bi-info-circle-fill text-muted" style="font-size: 0.8em;"></i>
            </label>
            <input type="number" class="form-control" @bind="StateService.EasingStrength" step="0.1" min="0" max="0.99" />
        </div>
        <div class="col-md-2">
            <label class="form-label" title="Meta de ocupação ideal como porcentagem da capacidade máxima do pátio.">
                Meta de Estoque (%) <i class="bi bi-info-circle-fill text-muted" style="font-size: 0.8em;"></i>
            </label>
            <div class="input-group">
                <input type="number" class="form-control" @bind="TargetPercent" step="1" min="0" max="100" />
                <span class="input-group-text">%</span>
            </div>
            <small class="text-muted">(@StateService.TargetYardTeu.ToString("N0") TEUs)</small>
        </div>
        <div class="col-md-2">
            <label class="form-label" title="Capacidade física máxima do pátio.">
                Capacidade Máx (TEU)
            </label>
            <input type="number" class="form-control" @bind="StateService.MaxYardTeu" />
        </div>

        <!-- Botões de Ação -->
        <div class="col-md-12 mt-2">
            @if (StateService.IsLoading)
            {
                <button class="btn btn-secondary" @onclick="CancelCalculation">Cancelar</button>
            }
            else
            {
                <button class="btn btn-primary" @onclick="CalculateSlots">Calcular</button>
            }

            <button class="btn btn-secondary" @onclick="ResetAllZoom" title="Restaura o zoom de todos os gráficos para o período total">Resetar Zoom</button>
        </div>
    </div>
</StickyFilter>

<CustomProgressBar IsLoading="@StateService.IsLoading" Label="Calculando..." />

<!-- Card: Taxas Calculadas -->
<div class="card mb-3">
    <div class="card-header">
        <h5 class="mb-0">Taxas Operacionais Calculadas</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <h6>Taxas de Navio (Vessel)</h6>
                <p>Embarque: @StateService.VesselLoadRate.ToString("F2") TEU/h</p>
                <p>Descarga: @StateService.VesselUnloadRate.ToString("F2") TEU/h</p>
            </div>
            <div class="col-md-6">
                <h6>Taxas de Trem (Rail)</h6>
                <p>Embarque: @StateService.TrainLoadRate.ToString("F2") TEU/h</p>
                <p>Descarga: @StateService.TrainUnloadRate.ToString("F2") TEU/h</p>
            </div>
        </div>
    </div>
</div>

<!-- Card: Gráfico Principal (Estoque) -->
<div class="card mb-3">
    <div class="card-header">
        <h5 class="mb-0">Análise de Janela Horária (Projeção de Estoque)</h5>
    </div>
    <div class="card-body">
        <canvas id="slotChart" width="400" height="100" style='width:100%;height:100px'></canvas>
    </div>
</div>

<!-- Card: Gráfico de Slots -->
<div class="card mb-3">
    <div class="card-header">
        <h5 class="mb-0">Resumo de Slots Sugeridos</h5>
    </div>
    <div class="card-body">
        <canvas id="slotsSummaryChart" width="400" height="100" style='width:100%;height:100px'></canvas>
    </div>
</div>

<!-- Card: Gráfico de Capacidade -->
<div class="card mb-3">
    <div class="card-header">
        <h5 class="mb-0">Dados de Capacidade (Gate e Movimentações)</h5>
    </div>
    <div class="card-body">
        <canvas id="capacityChart" width="400" height="100" style='width:100%;height:100px'></canvas>
    </div>
</div>

<!-- Card: Gráfico de Movimentação por Modal -->
<div class="card mb-3">
    <div class="card-header">
        <h5 class="mb-0">Entradas / Saídas por Modal</h5>
    </div>
    <div class="card-body">
        <canvas id="inOutChart" width="400" height="100" style='width:100%;height:100px'></canvas>
    </div>
</div>


@code {

    private double TargetPercent
    {
        get => StateService.MaxYardTeu > 0 ? Math.Round((double)StateService.TargetYardTeu / StateService.MaxYardTeu * 100, 1) : 0;
        set => StateService.TargetYardTeu = (int)(StateService.MaxYardTeu * (value / 100.0));
    }

    private double ReservePercent
    {
        get => Math.Round(StateService.ReserveRho * 100, 1);
        set => StateService.ReserveRho = value / 100.0;
    }

    private CancellationTokenSource cts;
    private DotNetObjectReference<SlotCalculatorPage>? objRef;

    private List<OracleEnvironment> oracleEnvironments = new();

    protected override async Task OnInitializedAsync()
    {
        StateService.OnChange += StateHasChanged;
        StateService.Load();

        var config = ConfigService.GetConfig();
        oracleEnvironments = config.OracleEnvironments ?? new List<OracleEnvironment>();

        StateService.InitializeState(state =>
        {
            if (string.IsNullOrEmpty(state.SelectedOracleEnvironment) && oracleEnvironments.Any())
            {
                state.SelectedOracleEnvironment = oracleEnvironments.First().Name;
            }
        });
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            objRef = DotNetObjectReference.Create(this);
            await JSRuntime.InvokeVoidAsync("addKeyboardShortcuts", objRef);
            await UpdateChart();
            await UpdateCapacityChart();
        }
    }

    public void Dispose()
    {
        StateService.OnChange -= StateHasChanged;
        StateService.Save();
        cts?.Dispose();

        if (objRef != null)
        {
            objRef.Dispose();
        }
    }

    private void OnRangeSelect(DateRange range)
    {
        StateService.StartDate = range.Start.DateTime;
        StateService.EndDate = range.End.DateTime;
    }

    [JSInvokable]
    public async Task HandleKeyPress(string key)
    {
        if (key == "Enter")
        {
            await CalculateSlots();
        }
    }

    private async Task CalculateSlots()
    {
        try
        {
            cts?.Cancel();
            cts = new CancellationTokenSource();

            StateService.ProgressValue = 0;
            StateService.IsLoading = true;

            // FIX: Só busca o estoque atual do banco se o usuário não tiver digitado nada (0)
            if (StateService.InitialYardTeu == 0)
            {
                StateService.InitialYardTeu = await OracleOpsService.GetCurrentYardTeuAsync(StateService.SelectedOracleEnvironment, cts.Token);
            }

            // Busca dados do período selecionado
            // O Service agora já cuida de buscar histórico (fallback) caso o período seja futuro
            if (StateService.GateTrucks.Count == 0
                || StateService.CachedStartDate != StateService.StartDate
                || StateService.CachedEndDate != StateService.EndDate
                || StateService.CachedEnvironment != StateService.SelectedOracleEnvironment)
            {
                StateService.Vessels = await OracleOpsService.FetchVesselPlansWithNamesAsync(StateService.StartDate, StateService.EndDate, StateService.SelectedOracleEnvironment, cts.Token);
                StateService.Rails = await OracleOpsService.FetchRailPlansWithNamesAsync(StateService.StartDate, StateService.EndDate, StateService.SelectedOracleEnvironment, cts.Token);
                StateService.GateTrucks = await OracleOpsService.FetchGateTrucksAsync(StateService.StartDate, StateService.EndDate, StateService.SelectedOracleEnvironment, cts.Token);
                StateService.YardMoves = await OracleOpsService.FetchYardMovesAsync(StateService.StartDate, StateService.EndDate, StateService.SelectedOracleEnvironment, cts.Token);
                StateService.CachedStartDate = StateService.StartDate;
                StateService.CachedEndDate = StateService.EndDate;
                StateService.CachedEnvironment = StateService.SelectedOracleEnvironment;
            }

            var gateTrucks = StateService.GateTrucks;
            var yardMoves = StateService.YardMoves;

            var caps = new Dictionary<DateTime, OpsCaps>();

            for (var t = StateService.StartDate; t <= StateService.EndDate; t = t.AddHours(1))
            {
                var gateTruckData = gateTrucks.TryGetValue(t, out var gt) ? gt : new InOut();
                var yardMoveCount = yardMoves.TryGetValue(t, out var ym) ? ym : 0;

                // Use separate in and out gate trucks for the hour
                caps[t] = new OpsCaps(t, gateTruckData.In, gateTruckData.Out, yardMoveCount);
            }

            var band = new YardBand(StateService.MinYardTeu, StateService.TargetYardTeu, StateService.MaxYardTeu);

            var vesselRates = await OracleOpsService.GetVesselLoadUnloadRatesAsync(StateService.SelectedOracleEnvironment, cts.Token);
            var trainRates = await OracleOpsService.GetTrainLoadUnloadRatesAsync(StateService.SelectedOracleEnvironment, cts.Token);

            StateService.VesselLoadRate = vesselRates?.LoadRateTeusPerHour ?? 0;
            StateService.VesselUnloadRate = vesselRates?.UnloadRateTeusPerHour ?? 0;
            StateService.TrainLoadRate = trainRates?.LoadRateTeusPerHour ?? 0;
            StateService.TrainUnloadRate = trainRates?.UnloadRateTeusPerHour ?? 0;

            StateService.HourWindows = SlotCalculator.ComputeHourWindows(
                StateService.StartDate,
                StateService.EndDate,
                StateService.InitialYardTeu,
                StateService.Vessels,
                StateService.Rails,
                caps,
                band,
                StateService.AvgTeuPerTruck,
                StateService.ReserveRho,
                StateService.EasingStrength,
                StateService.VesselLoadRate,
                StateService.VesselUnloadRate,
                StateService.TrainLoadRate,
                StateService.TrainUnloadRate
            ).ToList();

            StateService.ChartData = StateService.HourWindows.Select(hw => new SlotChartData
            {
                Timestamp = hw.T.ToString("o"),
                TotalSlots = hw.TotalSlots,
                SlotsIn = hw.SlotsIn,
                SlotsOut = hw.SlotsOut,
                MinYardTeu = StateService.MinYardTeu,
                TargetYardTeu = StateService.TargetYardTeu,
                MaxYardTeu = StateService.MaxYardTeu,
                YardTeuProjection = hw.YardTeuProjection,
                YardTeuNoGate = hw.YardTeuNoGate,
                TruckIn = hw.TruckIn,
                TruckOut = hw.TruckOut,
                VesselIn = hw.VesselIn,
                VesselOut = hw.VesselOut,
                RailIn = hw.RailIn,
                RailOut = hw.RailOut
            }).ToList();

            // Store capacity data for charting
            StateService.CapacityData = caps.Select(kvp => new CapacityChartData
            {
                Timestamp = kvp.Key.ToString("o"),
                GateTrucksIn = kvp.Value.GateTrucksInPerHour,
                GateTrucksOut = kvp.Value.GateTrucksOutPerHour,
                YardMoves = kvp.Value.YardMovesPerHour
            }).ToList();

            await UpdateChart();
            await UpdateCapacityChart();
        }
        catch (OperationCanceledException)
        {

        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Erro ao calcular slots: {Message}", ex.Message);
            toastService.ShowError($"Erro ao calcular slots: {ex.Message}");
        }
        finally
        {
            StateService.IsLoading = false;
        }
    }

    private void CancelCalculation()
    {
        StateService.IsLoading = false;
        cts?.Cancel();
    }

    private async Task ResetAllZoom()
    {
        await JSRuntime.InvokeVoidAsync("resetAllZooms");
    }

    private async Task UpdateChart()
    {
        if (StateService.ChartData == null || !StateService.ChartData.Any()) return;

        var labels = StateService.ChartData.Select(d => DateTime.Parse(d.Timestamp).ToString("dd/MM HH:mm")).ToArray();
        var dataTotalSlots = StateService.ChartData.Select(d => d.TotalSlots).ToArray();
        var dataSlotsIn = StateService.ChartData.Select(d => d.SlotsIn).ToArray();
        var dataSlotsOut = StateService.ChartData.Select(d => d.SlotsOut).ToArray();
        var minYardTeu = StateService.ChartData.Select(d => d.MinYardTeu).ToArray();
        var targetYardTeu = StateService.ChartData.Select(d => d.TargetYardTeu).ToArray();
        var maxYardTeu = StateService.ChartData.Select(d => d.MaxYardTeu).ToArray();
        var yardTeuProjection = StateService.ChartData.Select(d => d.YardTeuProjection).ToArray();

        var yardTeuNoGate = StateService.ChartData.Select(d => d.YardTeuNoGate).ToArray();

        var truckIn = StateService.ChartData.Select(d => d.TruckIn).ToArray();
        var truckOut = StateService.ChartData.Select(d => d.TruckOut).ToArray();
        var vesselIn = StateService.ChartData.Select(d => d.VesselIn).ToArray();
        var vesselOut = StateService.ChartData.Select(d => d.VesselOut).ToArray();

        var railIn = StateService.ChartData.Select(d => d.RailIn).ToArray();
        var railOut = StateService.ChartData.Select(d => d.RailOut).ToArray();

        // Per-class data
        var classDatasets = new List<object>();
        // Palette mantida para consistência visual
        var palette = new[]
        {
            "rgb(255,99,132)",
            "rgb(54,162,235)",
            "rgb(255,206,86)",
            "rgb(75,192,192)",
            "rgb(153,102,255)",
            "rgb(255,159,64)",
            "rgb(199,199,199)",
            "rgb(0,128,0)",
            "rgb(128,0,128)",
            "rgb(0,0,0)"
        };
        int colorIndex = 0;



        // Convert vessels and rails data to JavaScript-compatible format
        // Formato da chave ajustado para corresponder ao label (dd/MM HH:mm) pode ser necessário dependendo do JS
        // Mas mantendo yyyy-MM-dd HH:mm para compatibilidade com o objeto Date do JS se for parseado lá
        var vesselsData = new Dictionary<string, string[]>();
        var railsData = new Dictionary<string, string[]>();

        foreach (var kvp in StateService.Vessels)
        {
            var key = kvp.Key.ToString("yyyy-MM-dd HH:mm");
            vesselsData[key] = kvp.Value.VesselNames.ToArray();
        }

        foreach (var kvp in StateService.Rails)
        {
            var key = kvp.Key.ToString("yyyy-MM-dd HH:mm");
            railsData[key] = kvp.Value.TrainNames.ToArray();
        }

        var chartData = new
        {
            type = "line",
            data = new
            {
                labels = labels,
                datasets = new object[]
        {
            new
            {
            label = "Meta de Estoque (Target)", // Traduzido
            data = targetYardTeu,
            borderColor = "rgba(0,128,0,0.5)",
            borderDash = new[] {5,5},
            pointRadius = 0,
            fill = false
            },
            new
            {
            label = "Projeção Estoque (Sem Gate)", // Traduzido
            data = yardTeuNoGate,
            borderColor = "rgb(128,128,128)",
            tension = 0.4,
            cubicInterpolationMode = "monotone",
            pointRadius = 0
            },
            new
            {
            label = "Projeção Estoque (Com Gate)", // Traduzido
            data = yardTeuProjection,
            borderColor = "rgb(0, 128, 255)",
            tension = 0.4,
            cubicInterpolationMode = "monotone",
            pointRadius = 0
            },
        }
            },
            options = new
            {
                responsive = true,
                scales = new
                {
                    y = new
                    {
                        //beginAtZero = true,
                        title = new
                        {
                            display = true,
                            text = "TEUs"
                        }
                    },
                    x = new
                    {
                        title = new
                        {
                            display = true,
                            text = "Hora" // Traduzido
                        }
                    }
                },
                plugins = new
                {
                    tooltip = new
                    {
                        mode = "index",
                        intersect = false
                    }
                }
            },
            vessels = vesselsData,
            rails = railsData
        };
        await JSRuntime.InvokeVoidAsync("renderChart", "slotChart", chartData);

        var inOutChartData = new
        {
            type = "line",
            data = new
            {
                labels = labels,
                datasets = new object[]
                {
                    new
                    {
                        label = "Caminhão (Entrada)", // Traduzido
                        data = truckIn,
                        borderColor = "rgb(0,200,0)",
                        tension = 0.4,
                        cubicInterpolationMode = "monotone",
                        pointRadius = 0
                    },
                    new
                    {
                        label = "Caminhão (Saída)", // Traduzido
                        data = truckOut,
                        borderColor = "rgb(200,0,0)",
                        tension = 0.4,
                        cubicInterpolationMode = "monotone",
                        pointRadius = 0
                    },
                    new
                    {
                        label = "Navio (Entrada)", // Traduzido
                        data = vesselIn,
                        borderColor = "rgb(0,0,200)",
                        tension = 0.4,
                        cubicInterpolationMode = "monotone",
                        pointRadius = 0
                    },
                    new
                    {
                        label = "Navio (Saída)", // Traduzido
                        data = vesselOut,
                        borderColor = "rgb(200,0,200)",
                        tension = 0.4,
                        cubicInterpolationMode = "monotone",
                        pointRadius = 0
                    },
                    new
                    {
                        label = "Trem (Entrada)", // Traduzido
                        data = railIn,
                        borderColor = "rgb(128,128,0)",
                        tension = 0.4,
                        cubicInterpolationMode = "monotone",
                        pointRadius = 0
                    },
                    new
                    {
                        label = "Trem (Saída)", // Traduzido
                        data = railOut,
                        borderColor = "rgb(0,128,128)",
                        tension = 0.4,
                        cubicInterpolationMode = "monotone",
                        pointRadius = 0
                    }
                }
            },
            options = new
            {
                responsive = true,
                plugins = new
                {
                    tooltip = new
                    {
                        mode = "index",
                        intersect = false
                    }
                },
                scales = new
                {
                    y = new
                    {
                        title = new
                        {
                            display = true,
                            text = "TEUs"
                        }
                    },
                    x = new
                    {
                        title = new
                        {
                            display = true,
                            text = "Hora" // Traduzido
                        }
                    }
                }
            },
            vessels = vesselsData,
            rails = railsData
        };

        await JSRuntime.InvokeVoidAsync("renderChart", "inOutChart", inOutChartData);

        var slotsSummaryChartData = new
        {
            type = "line",
            data = new
            {
                labels = labels,
                datasets = new object[]
                {
                    new
                    {
                        label = "Total de Slots", // Traduzido
                        data = dataTotalSlots,
                        borderColor = "rgb(75, 192, 192)",
                        tension = 0.4,
                        cubicInterpolationMode = "monotone",
                        pointRadius = 0
                    },
                    new
                    {
                        label = "Slots (Entrada)", // Traduzido
                        data = dataSlotsIn,
                        borderColor = "rgb(235, 64, 52)",
                        tension = 0.4,
                        cubicInterpolationMode = "monotone",
                        pointRadius = 0
                    },
                    new
                    {
                        label = "Slots (Saída)", // Traduzido
                        data = dataSlotsOut,
                        borderColor = "rgb(153, 102, 255)",
                        tension = 0.4,
                        cubicInterpolationMode = "monotone",
                        pointRadius = 0
                    }
                }
            },
            options = new
            {
                responsive = true,
                plugins = new
                {
                    tooltip = new
                    {
                        mode = "index",
                        intersect = false,
                        enabled = true
                    }
                },
                interaction = new
                {
                    mode = "nearest",
                    axis = "x",
                    intersect = false
                }
            }
        };

        await JSRuntime.InvokeVoidAsync("renderChart", "slotsSummaryChart", slotsSummaryChartData);
    }


    private async Task UpdateCapacityChart()
    {
        if (StateService.CapacityData == null || !StateService.CapacityData.Any()) return;

        var labels = StateService.CapacityData.Select(d => DateTime.Parse(d.Timestamp).ToString("dd/MM HH:mm")).ToArray();
        var gateTrucksIn = StateService.CapacityData.Select(d => d.GateTrucksIn).ToArray();
        var gateTrucksOut = StateService.CapacityData.Select(d => d.GateTrucksOut).ToArray();
        var yardMoves = StateService.CapacityData.Select(d => d.YardMoves).ToArray();

        var capacityChartData = new
        {
            type = "line",
            data = new
            {
                labels = labels,
                datasets = new object[]
                {
                    new
                    {
                        label = "Caminhões Gate (Entrada)", // Traduzido
                        data = gateTrucksIn,
                        borderColor = "rgb(0, 200, 0)",
                        tension = 0.4,
                        cubicInterpolationMode = "monotone",
                        pointRadius = 0
                    },
                    new
                    {
                        label = "Caminhões Gate (Saída)", // Traduzido
                        data = gateTrucksOut,
                        borderColor = "rgb(200, 0, 0)",
                        tension = 0.4,
                        cubicInterpolationMode = "monotone",
                        pointRadius = 0
                    },
                    new
                    {
                        label = "Movimentações de Pátio", // Traduzido
                        data = yardMoves,
                        borderColor = "rgb(0, 0, 200)",
                        tension = 0.4,
                        cubicInterpolationMode = "monotone",
                        pointRadius = 0
                    }
                }
            },
            options = new
            {
                responsive = true,
                scales = new
                {
                    y = new
                    {
                        //beginAtZero = true,
                        title = new
                        {
                            display = true,
                            text = "Quantidade" // Traduzido
                        }
                    },
                    x = new
                    {
                        title = new
                        {
                            display = true,
                            text = "Hora" // Traduzido
                        }


                    }
                },
                plugins = new
                {
                    tooltip = new
                    {
                        mode = "index",
                        intersect = false
                    }
                }
            }
        };

        await JSRuntime.InvokeVoidAsync("renderChart", "capacityChart", capacityChartData);
    }
}
