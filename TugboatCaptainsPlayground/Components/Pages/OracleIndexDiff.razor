@page "/oracle-index-diff"
@using System.Reactive.Linq
@using System.Reactive.Subjects
@using System.Text.RegularExpressions
@using Common
@using Common.ExternalApis
@using Common.Models
@using Common.Services
@using Common.Services.Interfaces
@using Markdig
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.JSInterop
@using Microsoft.Extensions.Logging
@using TugboatCaptainsPlayground.Components.Shared
@inject IOracleSchemaService OracleSchemaService
@inject ToastService toastService
@inject IJSRuntime JS
@inject IConfigurationService ConfigService
@inject OracleIndexDiffStateService OracleIndexDiffStateService
@inject ILogger<OracleIndexDiff> _logger
@implements IDisposable

<CustomProgressBar ProgressValue="@OracleIndexDiffStateService.ProgressValue" Label="@OracleIndexDiffStateService.ProgressLabel" IsLoading="@OracleIndexDiffStateService.IsLoading" />

<StickyFilter>
    <div class="col-md-5">
        <div class="form-group">
            <label class="form-label">Ambiente Origem:</label>
            <EnvironmentSelector
                Environments="environments"
                @bind-SelectedEnvironmentName="OracleIndexDiffStateService.SelectedSourceEnv" />
        </div>
    </div>
    <div class="col-md-5">
        <div class="form-group">
            <label class="form-label">Ambiente Destino:</label>
            <EnvironmentSelector
                Environments="environments"
                @bind-SelectedEnvironmentName="OracleIndexDiffStateService.SelectedTargetEnv" />
        </div>
    </div>
    <div class="col-md-2">
        <button class="btn btn-primary w-100 mt-4" @onclick="CompareEnvironments">Comparar</button>
        @if (OracleIndexDiffStateService.SourceValues?.Any() == true)
        {
            <button class="btn btn-secondary w-100 mt-2" @onclick="CopyMissingIndexesSQL" title="Copy SQL to create missing indexes in Target">
                <i class="bi bi-clipboard"></i> Copy Missing SQL
            </button>
        }
    </div>

    <div class="row g-3 mt-2">
        <div class="col-md-6">
            <div class="form-group">
                <input type="text" class="form-control" placeholder="Buscar por nome do índice..."
                @bind="OracleIndexDiffStateService.SearchKey"
                @bind:event="oninput"
                @onkeyup="HandleSearch" />
            </div>
        </div>
    </div>

    <div class="col-md-2">
        <div class="form-check form-switch mt-3">
            <input class="form-check-input" type="checkbox" role="switch"
            id="showOnlyMissing" @bind="OracleIndexDiffStateService.ShowOnlyMissing" @bind:after="HandleSearch">
            <label class="form-check-label" for="showOnlyMissing" title="Mostrar apenas índices ausentes no destino">Mostrar apenas ausentes</label>
        </div>
    </div>
</StickyFilter>

@if (OracleIndexDiffStateService.PageItems.Any())
{
    <div class="container-fluid mt-3">
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Nome do Índice</th>
                        <th>Tabela</th>
                        <th>Tipo</th>
                        <th>Unicidade</th>
                        <th>Colunas</th>
                        <th>Origem</th>
                        <th>Destino</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in OracleIndexDiffStateService.PageItems)
                    {
                        var sourceIndex = OracleIndexDiffStateService.SourceValues.TryGetValue(item.Key, out var src) ? src : null;
                        var targetIndex = OracleIndexDiffStateService.TargetValues.TryGetValue(item.Key, out var tgt) ? tgt : null;

                        <tr class="@(sourceIndex == null ? "table-danger" : targetIndex == null ? "table-warning" : "")">
                            <td>@item.Key</td>
                            <td>@(sourceIndex?.TableName ?? targetIndex?.TableName ?? "-")</td>
                            <td>@(sourceIndex?.IndexType ?? targetIndex?.IndexType ?? "-")</td>
                            <td>@(sourceIndex?.Uniqueness ?? targetIndex?.Uniqueness ?? "-")</td>
                            <td class="text-truncate" style="max-width: 300px;" title="@(sourceIndex?.Columns ?? targetIndex?.Columns)">
                                @(sourceIndex?.Columns ?? targetIndex?.Columns ?? "-")
                            </td>
                            <td>
                                @if (sourceIndex != null)
                                {
                                    <span class="badge bg-success">Presente</span>
                                }
                                else
                                {
                                    <span class="badge bg-danger">Ausente</span>
                                }
                            </td>
                            <td>
                                @if (targetIndex != null)
                                {
                                    <span class="badge bg-success">Presente</span>
                                }
                                else
                                {
                                    <span class="badge bg-danger">Ausente</span>
                                }
                            </td>
                            <td>
                                @if (sourceIndex != null)
                                {
                                    <button class="btn btn-sm btn-outline-primary" @onclick="() => ExportIndexDDL(item.Value, OracleIndexDiffStateService.SelectedSourceEnv)">
                                        <i class="bi bi-download"></i> DDL
                                    </button>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
}

<CustomPagination State="@OracleIndexDiffStateService" OnPageChange="@ChangePage"/>

<style>
    .form-group {
        margin-bottom: 0;
    }
</style>

@code {
    private List<OracleEnvironment> environments = new();
    private PaginationService<string, OracleIndexDefinition, OracleIndexDiffResult> paginationService;

    protected override async Task OnInitializedAsync()
    {
        var config = ConfigService.GetConfig();
        environments = config.OracleEnvironments;

        OracleIndexDiffStateService.OnChange += () => InvokeAsync(StateHasChanged);
        OracleIndexDiffStateService.Load();

        paginationService = new PaginationService<string, OracleIndexDefinition, OracleIndexDiffResult>(
            OracleIndexDiffStateService,
            async () =>
            {
                var sourceEnv = environments.First(e => e.Name == OracleIndexDiffStateService.SelectedSourceEnv);
                return (await OracleSchemaService.GetIndexDefinitionsAsync(sourceEnv.ConnectionString, sourceEnv.Schema))
                    .ToDictionary(i => i.Owner + "." + i.IndexName);
            },
            async () =>
            {
                var targetEnv = environments.First(e => e.Name == OracleIndexDiffStateService.SelectedTargetEnv);
                return (await OracleSchemaService.GetIndexDefinitionsAsync(targetEnv.ConnectionString, targetEnv.Schema))
                    .ToDictionary(i => i.Owner + "." + i.IndexName);
            },
            (indexName, source, target) =>
            {
                // For indexes, we just check if they exist or not (presence/absence)
                var hasDifferences = (source == null) != (target == null);
                var diffString = source == null ? "Index missing in source" : target == null ? "Index missing in target" : "Index exists in both";
                return Task.FromResult(new OracleIndexDiffResult(indexName, diffString, hasDifferences, source));
            },
            (indexName, source, target, diff) => Task.FromResult(
                (string.IsNullOrEmpty(OracleIndexDiffStateService.SearchKey) ||
                (!string.IsNullOrEmpty(OracleIndexDiffStateService.SearchKey) &&
                indexName.Contains(OracleIndexDiffStateService.SearchKey, StringComparison.OrdinalIgnoreCase))) &&
                (!OracleIndexDiffStateService.ShowOnlyMissing || target == null))
        );
    }

    public void Dispose()
    {
        OracleIndexDiffStateService.OnChange -= () => InvokeAsync(StateHasChanged);
        OracleIndexDiffStateService.Save();
    }

    public async Task ExportIndexDDL(OracleIndexDefinition index, string envName)
    {
        try
        {
            var config = ConfigService.GetConfig();
            var env = config.OracleEnvironments.FirstOrDefault(e => e.Name == envName);

            if (env == null)
            {
                toastService.ShowError($"Environment {envName} not found");
                return;
            }

            var createScript = await OracleSchemaService.GetIndexCreateScriptAsync(env.ConnectionString, index);

            if (!string.IsNullOrEmpty(createScript))
            {
                var fileName = $"{index.Owner}.{index.IndexName}_{envName}_{DateTime.Now:yyyyMMdd}.sql".Replace(" ", "_");
                await DownloadFile(fileName, createScript);
                toastService.ShowSuccess($"Downloaded {fileName}");
            }
            else
            {
                toastService.ShowError($"Index {index.IndexName} not found or could not generate DDL in {envName}");
            }
        }
        catch (Exception ex)
        {
            toastService.ShowError($"Error exporting DDL: {ex.Message}");
        }
    }

    private async Task DownloadFile(string fileName, string fileContent)
    {
        var byteArray = System.Text.Encoding.UTF8.GetBytes(fileContent);
        var base64Content = Convert.ToBase64String(byteArray);
        await JS.InvokeVoidAsync("downloadFile", fileName, base64Content);
    }

    private async Task CopyMissingIndexesSQL()
    {
        try
        {
            if (string.IsNullOrEmpty(OracleIndexDiffStateService.SelectedSourceEnv))
            {
                toastService.ShowError("Source environment not selected");
                return;
            }

            var sourceEnv = environments.FirstOrDefault(e => e.Name == OracleIndexDiffStateService.SelectedSourceEnv);
            if (sourceEnv == null)
            {
                toastService.ShowError($"Environment {OracleIndexDiffStateService.SelectedSourceEnv} not found");
                return;
            }

            var schema = sourceEnv.Schema.ToUpper();

            // Find indexes present in Source but missing in Target
            var missingIndexKeys = OracleIndexDiffStateService.SourceValues.Keys
                .Where(key => !OracleIndexDiffStateService.TargetValues.ContainsKey(key))
                .ToList();

            if (!missingIndexKeys.Any())
            {
                toastService.ShowInfo("No missing indexes found to generate SQL for.");
                return;
            }

            var missingIndexNames = missingIndexKeys
                .Select(key => OracleIndexDiffStateService.SourceValues[key].IndexName)
                .ToList();

            var indexList = string.Join(",\n            ", missingIndexNames.Select(i => $"'{i}'"));

            var sql = $@"DECLARE
    v_ddl CLOB;
BEGIN
    FOR r IN (
        SELECT index_name
        FROM   all_indexes
        WHERE  owner = '{schema}'
        AND    index_name IN (
            {indexList}
        )
    ) LOOP
        v_ddl := DBMS_METADATA.GET_DDL('INDEX', r.index_name, '{schema}');
        DBMS_OUTPUT.PUT_LINE('----------------------------------------');
        DBMS_OUTPUT.PUT_LINE('--' || r.index_name);
        DBMS_OUTPUT.PUT_LINE('----------------------------------------');
        DBMS_OUTPUT.PUT_LINE(v_ddl);
        DBMS_OUTPUT.PUT_LINE(CHR(10));
    END LOOP;
END;
/";

            await JS.InvokeVoidAsync("navigator.clipboard.writeText", sql);
            toastService.ShowSuccess($"Copied SQL for {missingIndexNames.Count} missing indexes");
        }
        catch (Exception ex)
        {
            toastService.ShowError($"Error copying SQL: {ex.Message}");
        }
    }

    private async Task CompareEnvironments()
    {
        if (string.IsNullOrEmpty(OracleIndexDiffStateService.SelectedSourceEnv) || string.IsNullOrEmpty(OracleIndexDiffStateService.SelectedTargetEnv))
        {
            toastService.ShowError("Please select both environments");
            return;
        }

        try
        {
            // Initialize pagination service
            await paginationService.InitializeAsync();

            // Get differences for the current page
            await paginationService.GetPageAsync();
        }
        catch (Exception ex)
        {
            toastService.ShowError($"Error comparing environments: {ex.Message}");
        }
    }

    private async Task HandleSearch()
    {
        OracleIndexDiffStateService.CurrentPage = 1;
        await paginationService.GetPageAsync();
    }

    private async Task ChangePage(int page)
    {
        OracleIndexDiffStateService.CurrentPage = page;
        await paginationService.GetPageAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            OracleIndexDiffStateService.InitializeState(async x =>
            {
                if (environments.Count >= 2)
                {
                    x.SelectedSourceEnv = environments[0].Name;
                    x.SelectedTargetEnv = environments.Count > 1 ? environments[1].Name : environments[0].Name;
                    await CompareEnvironments();
                }
            });
        }
    }
}
